/*
 * This file was generated by the Gradle 'init' task.
 *
 * This generated file contains a sample Java library project to get you started.
 * For more details take a look at the 'Building Java & JVM projects' chapter in the Gradle
 * User Manual available at https://docs.gradle.org/7.5/userguide/building_java_projects.html
 */

plugins {
    // Apply the java-library plugin for API and implementation separation.
    id 'com.github.johnrengelman.shadow' version '7.1.2'    
    id "com.google.protobuf" version "0.8.19"
    id 'maven-publish'
    id "com.jfrog.artifactory" version "4.28.2"
    id 'java-library'
}

group 'com.snapscore'
version "${JAR_VERSION}"

sourceCompatibility = 17.0
targetCompatibility = 17.0

repositories {
    // Use Maven Central for resolving dependencies.
    mavenCentral()
}

def protobufVersion = '3.21.5'
def protocVersion = '3.21.5'
def protocGrpcVersion = '1.48.1'
dependencies { 
    implementation "com.google.protobuf:protobuf-java:${protobufVersion}"
}


sourceSets {
  main {
    proto {
      // In addition to the default 'src/main/proto'
      srcDir 'proto'
    }
  }  
}

protobuf {

    plugins {
        grpc {
            artifact = "io.grpc:protoc-gen-grpc-java:${protocGrpcVersion}"
        }
    }

    protoc {
        artifact = "com.google.protobuf:protoc:${protocVersion}"
    }
    generateProtoTasks {
        all()*.plugins {
            grpc {}
        }
    }
}

shadowJar {
    archiveBaseName = project.name
    classifier = ''
    archiveVersion = version
}

jar {
    manifest {
        attributes 'Implementation-Title': 'PROTOBUF',
                'Implementation-Version': version
    }
}

// Allows the Fat Jar to be uploaded to Artifactory
artifacts {
    archives shadowJar
}
artifactoryPublish {
    dependsOn shadowJar
}

publishing {
    publications {
        mavenJava(MavenPublication) {
            from components.java
        }
    }
}

artifactory {
       //The base Artifactory URL if not overridden by the publisher/resolver
    contextUrl = "https://deploy.snapscore.dev/artifactory"
    publish {
        //A closure defining publishing information
        repository {
            // The Artifactory repository key to publish to, ex. 'libs-snapshot'
            repoKey = "${repo}"

            // The publisher user name
            username = "${artifactory_user}"

            // The publisher password
            password = "${artifactory_password}"
        }
        publishArtifacts = true
        publishPom = true
        defaults {
            publications('mavenJava')
        }
    }    
}
